@if(authService.isMD()) {
<cranix-toolbar
  title="{{'Calendar' | translate}} {{ viewDate | calendarDate:(view + 'ViewTitle'):'en' }}"></cranix-toolbar>
} @else {
<cranix-toolbar title="{{'Calendar' | translate}}"></cranix-toolbar>
<ion-toolbar class="page-toolbar">
  <ion-buttons slot="start">
    <ion-button mwlCalendarPreviousView [view]="view" [(viewDate)]="viewDate"
      (viewDateChange)="closeOpenMonthViewDay()">
      &lt;&lt;
    </ion-button>
    <ion-button mwlCalendarToday [(viewDate)]="viewDate">
      {{'today'|translate}}
    </ion-button>
    <ion-button mwlCalendarNextView [view]="view" [(viewDate)]="viewDate" (viewDateChange)="closeOpenMonthViewDay()">
      &gt;&gt;
    </ion-button>
  </ion-buttons>
  <center>{{ viewDate | calendarDate:(view + 'ViewTitle'):'en' }}</center>
  <ion-buttons slot="end">
    <ion-button (click)="setView(CalendarView.Month)">
      {{'Month'|translate}}
    </ion-button>
    <ion-button (click)="setView(CalendarView.Week)">
      {{'Week'|translate}}
    </ion-button>
    <ion-button (click)="setView(CalendarView.Day)">
      {{'Day'|translate}}
    </ion-button>
    <ion-button fill="solid" (click)="loadData()">
      <ion-icon name="refresh" slot="icon-only"></ion-icon>
    </ion-button>
    <ion-button fill="solid" (click)="addNewEvent()">
      <ion-icon name="add-circle" slot="icon-only"></ion-icon>
    </ion-button>
  </ion-buttons>
</ion-toolbar>
}
<ion-content [fullscreen]="true">
  @if(authService.isMD()) {
  <ion-fab slot="fixed" vertical="top" horizontal="end">
    <ion-fab-button>
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
    <ion-fab-list side="start">
      <ion-fab-button mwlCalendarNextView [view]="view" [(viewDate)]="viewDate"
        (viewDateChange)="closeOpenMonthViewDay()">
        &gt;&gt;
      </ion-fab-button>
      <ion-fab-button mwlCalendarToday [(viewDate)]="viewDate">
        {{'today'|translate}}
      </ion-fab-button>
      <ion-fab-button mwlCalendarPreviousView [view]="view" [(viewDate)]="viewDate"
        (viewDateChange)="closeOpenMonthViewDay()">
        &lt;&lt;
      </ion-fab-button>
    </ion-fab-list>
    <ion-fab-list side="bottom">
      <ion-fab-button (click)="setView(CalendarView.Month)">
        {{'Month'|translate}}
      </ion-fab-button>
      <ion-fab-button (click)="setView(CalendarView.Week)">
        {{'Week'|translate}}
      </ion-fab-button>
      <ion-fab-button (click)="setView(CalendarView.Day)">
        {{'Day'|translate}}
      </ion-fab-button>
      <ion-fab-button (click)="loadData()">
        <ion-icon name="refresh"></ion-icon>
      </ion-fab-button>
      <ion-fab-button (click)="addNewEvent()">
        <ion-icon name="add-circle"></ion-icon>
      </ion-fab-button>
    </ion-fab-list>
  </ion-fab>
  }
  <div [ngSwitch]="view">
    <mwl-calendar-month-view *ngSwitchCase="CalendarView.Month" [viewDate]="viewDate" [events]="events"
      [refresh]="refresh" [activeDayIsOpen]="activeDayIsOpen" (dayClicked)="dayClicked($event.day)"
      (eventClicked)="handleEvent('Clicked', $event.event)" (eventTimesChanged)="eventTimesChanged($event)"
      (beforeViewRender)="updateCalendarEvents($event)">
    </mwl-calendar-month-view>
    <mwl-calendar-week-view *ngSwitchCase="CalendarView.Week" [viewDate]="viewDate" [events]="events"
      [refresh]="refresh" (eventClicked)="handleEvent('Clicked', $event.event)"
      (eventTimesChanged)="eventTimesChanged($event)" (beforeViewRender)="updateCalendarEvents($event)">
    </mwl-calendar-week-view>
    <mwl-calendar-day-view *ngSwitchCase="CalendarView.Day" [viewDate]="viewDate" [events]="events" [refresh]="refresh"
      (eventClicked)="handleEvent('Clicked', $event.event)" (eventTimesChanged)="eventTimesChanged($event)"
      (beforeViewRender)="updateCalendarEvents($event)">
    </mwl-calendar-day-view>
  </div>
  <ion-modal #addEditEventModal [isOpen]="isModalOpen">
    <ng-template>
      @if(selectedEvent){
      <form #addEditEventForm="ngForm">
        <ion-header color="primary">
          <ion-toolbar color="primary">
            <ion-title>{{addEditEventTitle|translate}}</ion-title>
            <ion-buttons slot="end">
              @if(isWritable()) {
              <ion-button class="ion-no-margin" (click)="addEditEvent(addEditEventModal)"
                [disabled]="!addEditEventForm.valid">
                <ion-icon slot="icon-only" color="success" name="checkmark-sharp"></ion-icon>
              </ion-button>
              }
              <ion-button fill="clear" size="small" (click)="toggleAddEditModal(false)">
                <ion-icon slot="icon-only" color="danger" name="close"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content [fullscreen]="true">
          <ion-list [inset]="true">
            <ion-item>
              <ion-input [(ngModel)]="selectedEvent.title" name="title" type="text" labelPlacement="fixed"
                label="{{'title'|translate}}*" required></ion-input>
            </ion-item>
            <ion-item>
              <ion-input [(ngModel)]="selectedEvent.description" name="description" type="text-area"
                labelPlacement="fixed" label="{{'description'|translate}}"></ion-input>
            </ion-item>
            <ion-item>
              <ion-input [(ngModel)]="selectedEvent.location" name="location" type="text" labelPlacement="fixed"
                label="{{'location'|translate}}"></ion-input>
            </ion-item>
            <ion-item>
              <ion-toggle [(ngModel)]="selectedEvent.allDay" name="allDay" labelPlacement="start"
                (ionChange)="adaptEventTimes()">{{'allDay'|translate}}</ion-toggle>
            </ion-item>
            @if(selectedEvent.allDay) {
            <ion-item>
              <ion-input [(ngModel)]="selectedEvent.start" name="startTime" type="date" labelPlacement="fixed"
                label="{{'From'|translate}}*" required></ion-input>
            </ion-item>
            <ion-item>
              <ion-input [(ngModel)]="selectedEvent.end" name="endTime" type="date" labelPlacement="fixed"
                label="{{'Until'|translate}}*" required></ion-input>
            </ion-item>
            } @else {
            <ion-item>
              <ion-label>{{'From'|translate}}</ion-label>
              <ion-datetime-button datetime="eventStartTime"></ion-datetime-button>
            </ion-item>
            <ion-item>
              <ion-label>{{'Until'|translate}}</ion-label>
              <ion-datetime-button datetime="eventEndTime"></ion-datetime-button>
            </ion-item>
            }
            <ion-modal [keepContentsMounted]="true">
              <ng-template>
                <ion-datetime id="eventStartTime" [(ngModel)]="selectedEvent.start" name="startTimeModal"
                  [minuteValues]="eventMinuteValues" [yearValues]="yearValues" [min]="minDate"
                  [max]="maxDate"></ion-datetime>
              </ng-template>
            </ion-modal>
            <ion-modal [keepContentsMounted]="true">
              <ng-template>
                <ion-datetime id="eventEndTime" [(ngModel)]="selectedEvent.end" name="endTimeModal"
                  [minuteValues]="eventMinuteValues" [yearValues]="yearValues" [min]="minDate"
                  [max]="maxDate"></ion-datetime>
              </ng-template>
            </ion-modal>
            <ion-item>
              <ion-label>{{'Groups for the Event' | translate}}</ion-label>
              <ionic-selectable #ionicSelectGroups itemValueField="id" itemTextField="description" [isMultiple]="true"
                [(ngModel)]="selectedEvent.groups" [ngModelOptions]="{standalone: true}" [items]="calendars"
                [canSearch]="true">
                <ng-template ionicSelectableHeaderTemplate>
                  <ion-header color="primary">
                    <ion-toolbar>
                      <ion-title>
                        {{ "Select groups for the event" | translate }}
                      </ion-title>
                      <ion-buttons slot="end">
                        <ion-button ion-button (click)="ionicSelectGroups.close()">
                          <ion-icon color="danger" name="close"></ion-icon>
                        </ion-button>
                      </ion-buttons>
                    </ion-toolbar>
                  </ion-header>
                </ng-template>
                <ng-template ionicSelectableValueTemplate let-ports="value">
                  <div class="ionic-selectable-value-item">
                    {{ports.length}} {{'groups are seleceted'|translate}}
                  </div>
                </ng-template>
              </ionic-selectable>
            </ion-item>
            <ion-item>
              <ion-label>{{'Users for the event' | translate}}</ion-label>
              <ionic-selectable #ionicSelectUsers itemValueField="id" itemTextField="fullName" [isMultiple]="true"
                [(ngModel)]="selectedEvent.users" [ngModelOptions]="{standalone: true}"
                [items]="objectS.allObjects['user']" [canSearch]="true">
                <ng-template ionicSelectableHeaderTemplate>
                  <ion-header color="primary">
                    <ion-toolbar>
                      <ion-title>
                        {{ "Select users for the event" | translate }}
                      </ion-title>
                      <ion-buttons slot="end">
                        <ion-button ion-button (click)="ionicSelectUsers.close()">
                          <ion-icon color="danger" name="close"></ion-icon>
                        </ion-button>
                      </ion-buttons>
                    </ion-toolbar>
                  </ion-header>
                </ng-template>
                <ng-template ionicSelectableValueTemplate let-ports="value">
                  <div class="ionic-selectable-value-item">
                    {{ports.length}} {{'users are seleceted'|translate}}
                  </div>
                </ng-template>
              </ionic-selectable>
            </ion-item>
          </ion-list>
          <ion-list [inset]="true">
            <ion-item>
              <ion-toggle [(ngModel)]="eventRecurring" name="recurring"
                labelPlacement="start">{{'Recurring'|translate}}</ion-toggle>
            </ion-item>
            <ion-item>
              <ion-select [(ngModel)]="selectedEvent.rrule.freq" name="rruleFreq" label="{{'Freq'|translate}}" labelPlacement="start"
                [disabled]="!eventRecurring">
                <ion-select-option *ngFor="let freq of rruleFrequents; index as i" [value]="i">{{freq | translate}}</ion-select-option>
              </ion-select>
            </ion-item>
            <ion-item>
              <ion-input [(ngModel)]="selectedEvent.rrule.interval" name="rruleInterval" type="number"
                label="{{'Interval'|translate}}" [disabled]="!eventRecurring"></ion-input>
            </ion-item>
            <ion-item>
              <ion-input [(ngModel)]="selectedEvent.rrule.count" name="rruleCount" type="number"
                label="{{'Count'|translate}}" [disabled]="!eventRecurring"></ion-input>
            </ion-item>
            <ion-item>
              <ion-select [(ngModel)]="selectedEvent.rrule.byweekday" name="byweekday" label="{{'Weekday'|translate}}" labelPlacement="start" [multiple]="true"
                [disabled]="!eventRecurring">
                <ion-select-option *ngFor="let day of rruleDays" [value]="day">{{day | translate}}</ion-select-option>
              </ion-select>
            </ion-item>
            <ion-item>
              <ion-select [(ngModel)]="selectedEvent.rrule.byweekday" name="byweekday" label="{{'Month'|translate}}" labelPlacement="start" [multiple]="true"
                [disabled]="!eventRecurring">
                <ion-select-option *ngFor="let month of rruleMonths; index as j" [value]="j">{{month | translate}}</ion-select-option>
              </ion-select>
            </ion-item>
          </ion-list>
        </ion-content>
      </form>
      }
    </ng-template>
  </ion-modal>
</ion-content>